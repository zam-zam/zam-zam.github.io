<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Kubernetes What If...? &ndash; Of Code & Systems</title><meta name=description property="og:description" content="Что произойдёт, если Перезапустить kubelet Контейнеры продолжают работать, но в момент синхронизации состояния подов с api-server поды могут переходить в состояние 0/1 Running, когда трафик на них перестаёт направляться
Остановить kubelet Нода переходит в состояние NotReady, никаких событий на подах не происходит - они продолжают пребывать в состоянии 1/1 Running, но трафик на них перестаёт идти (из endpoint'ов сервисов удаляются IP адрес подов, которые находятся на &amp;ldquo;мёртвой&amp;rdquo; ноде).
Спустя указанный pod-eviction-timeout (5m по-умолчанию) для kube-controller-manager поды переходят в статус Terminating и начинают запускаться на живых воркерках. Поды будут продолжать находиться в статусе Terminating либо до старта kubelet, либо до удаления ноды из кластера. При этом не выгоняются поды DaemonSet и поды, поднятые kubelet'ом(kube-proxy, nginx-proxy, kube-flannel, nodelocaldns и т.п.)
|"><meta name=apple-mobile-web-app-title content="Of Code & Systems"><link rel=stylesheet href=/assets/syntax.css><link rel=stylesheet href=/assets/primer-build.css><link rel=stylesheet href=/assets/style.css></head><body class=bg-gray><div id=holy class="container-lg bg-white h-100"><div id=header class="px-1 bg-white"><nav class="UnderlineNav UnderlineNav--right px-2"><a class="UnderlineNav-actions muted-link h2" href=/>Of Code & Systems</a></nav></div><div role=main id=main class="holy-main markdown-body px-4 bg-white"><div class=Subhead><div class=Subhead-heading><div class="h1 mt-3 mb-1">Kubernetes What If...?</div></div><div class=Subhead-description><a href=/categories/kubernetes class=muted-link><span class="Label Label--gray-darker">kubernetes</span></a><div class=float-md-right><span title="Lastmod: 2020-09-29. Published at: 2020-09-29.">Published: 2020-09-29</span></div></div></div><article><section class="pb-6 mb-3 border-bottom"><div id=toc class="Box Box--blue mb-3"><b>Содержание</b><nav id=TableOfContents><ul><li><a href=#-->Что произойдёт, если</a><ul><li><a href=#-kubelet>Перезапустить kubelet</a></li><li><a href=#-kubelet1>Остановить kubelet</a></li><li><a href=#-docker>Перезапустить docker</a></li><li><a href=#-docker1>Остановить docker</a></li><li><a href=#--->Закончится место на диске</a></li></ul></li></ul></nav></div><h1 id=-->Что произойдёт, если</h1><h2 id=-kubelet>Перезапустить kubelet</h2><p>Контейнеры продолжают работать, но в момент синхронизации состояния подов с api-server поды могут переходить в состояние 0/1 Running, когда трафик на них перестаёт направляться</p><h2 id=-kubelet1>Остановить kubelet</h2><p>Нода переходит в состояние NotReady, никаких событий на подах не происходит - они продолжают пребывать в состоянии 1/1 Running, но трафик на них перестаёт идти (из endpoint'ов сервисов удаляются IP адрес подов, которые находятся на &ldquo;мёртвой&rdquo; ноде).</p><p>Спустя указанный pod-eviction-timeout (5m по-умолчанию) для <a href=https://kubernetes.io/docs/reference/command-line-tools-reference/kube-controller-manager/>kube-controller-manager</a> поды переходят в статус Terminating и начинают запускаться на живых воркерках. Поды <a href=https://github.com/kubernetes/kubernetes/issues/55713>будут продолжать</a> находиться в статусе Terminating либо до старта kubelet, либо до удаления ноды из кластера. При этом не выгоняются поды DaemonSet и поды, поднятые kubelet'ом(kube-proxy, nginx-proxy, kube-flannel, nodelocaldns и т.п.)</p><h2 id=-docker>Перезапустить docker</h2><p>Все контейнеры перезапускаются по событию <code>Pod sandbox changed, it will be killed and re-created</code></p><h2 id=-docker1>Остановить docker</h2><p>Kubelet не может обратиться к сокету docker, нода переходит в статус NotReady. Далее происходит то же самое, что при остановке kubelet (pod-eviction-timeout). Есть проблема, если используется statefulSet - номерной под не сможет запуститься на другой ноде, пока он не завершится полностью на &ldquo;мёртвой&rdquo;</p><ul><li><a href=https://github.com/kubernetes/kubernetes/issues/72226>https://github.com/kubernetes/kubernetes/issues/72226</a></li><li><a href=https://github.com/kubernetes/kubernetes/issues/74689>https://github.com/kubernetes/kubernetes/issues/74689</a></li></ul><h2 id=--->Закончится место на диске</h2><p>С точки зрения kubelet существует разделение на 2 файловые системы:</p><ul><li>nodefs - используется для томов (volumes), логов демона kubelet и тому подобное (обычно root раздел)</li><li>imagefs - используется для хранения образов и слоёв контейнеров (/var/lib/docker)</li></ul><p>Если imagefs не смонтирован отдельно, то считается, что он находится там же, где nodefs</p><p>По-умолчанию действуют 4 Hard Eviction правила (нода получит состояние DiskPressure)</p><ul><li>memory.available&lt;100Mi</li><li>nodefs.available&lt;10%</li><li>nodefs.inodesFree&lt;5%</li><li>imagefs.available&lt;15%</li></ul><p>При срабатывании части этих правил kubelet попробует освободить место на диске:</p><ul><li>imagefs &lt;15% Available: очистка неиспользуемых образов</li><li>nodefs &lt;10% Available: удаление мёртвых подов и их контейнеров</li></ul><p>Если не удаётся освободить место, то поды выгоняются (Evicted) и стартуют на других нодах. Основная проблема в том, что выгоняются в том числе системные поды (типа kube-flannel) и по сути нода перестаёт работать</p></section><section><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"blog-zamolod-ru"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></article></div><div id=footer class="pt-2 pb-3 bg-white text-center"><span class="text-small text-gray">Powered by the
<a href=https://github.com/qqhann/hugo-primer class=link-gray-dark>Hugo-Primer</a> theme for
<a href=https://gohugo.io class=link-gray-dark>Hugo</a>.</span></div></div><script type=text/javascript src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script type=text/x-mathjax-config>MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script></body></html>