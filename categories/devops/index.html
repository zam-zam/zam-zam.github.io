<!doctype html><html>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<title>
devops &ndash; Of Code & Systems
</title>
<meta name=description property="og:description" content>
<meta name=apple-mobile-web-app-title content="Of Code & Systems">
<link rel=stylesheet href=/assets/syntax.css>
<link rel=stylesheet href=/assets/primer-build.css>
<link rel=stylesheet href=/assets/style.css>
</head>
<body class=bg-gray style=background-color:#fdf6e3!important>
<div id=holy class="container-lg bg-white h-100">
<div id=header class="px-1 bg-white">
<nav class="UnderlineNav UnderlineNav--right px-2">
<a class="UnderlineNav-actions muted-link h2" href=https://zzamzam.dev/>
Of Code & Systems
</a>
</nav>
</div>
<div role=main id=main class="holy-main markdown-body px-4 bg-white">
<div>
<h1>devops</h1>
<div class="rounded-2 box-shadow-medium px-3 pb-2 pt-2 mb-3">
<div class="Subhead mb-2">
<div class=Subhead-heading>
<a href=/2020/06/gitlab-avoid-double-pipeline-run/>
<div class="h2 mt-1 mb-1">Как избежать запуска двойного pipeline при использовании merge requests pipelines?</div>
</a>
</div>
<div class=Subhead-description>
<a href=/categories/gitlab class=muted-link>
<span class="Label Label--gray-darker">gitlab</span>
</a>
<a href=/categories/devops class=muted-link>
<span class="Label Label--gray-darker">devops</span>
</a>
<div class=float-md-right>
<span>2020-06-15</span>
</div>
</div>
</div>
<div class=text-gray>
<p><a href=https://docs.gitlab.com/ee/ci/merge_request_pipelines/>Пайплайны для Merge Requests</a> существуют отдельно (имеют лейбл detached) и запускается независимо от основного pipeline. Из-за этого если сделать push в репу в ветку, из которой в гитлабе есть открытый МР, то запускаются 2 одинаковых пайплайна</p>
<p><img src=/wp-content/uploads/2020/06/double-pipeline.png alt>
 
Есть варианта, чтобы это избежать:</p>
<ol>
<li>Дублировать все джобы через extends, чтобы разделить на запускаемые на МРах и на обычные</li>
<li>Не запускать CI на некоторых ветках, пока из них нет открытого МРа</li>
</ol>
<div>
<a href=/2020/06/gitlab-avoid-double-pipeline-run/>Открыть полностью…</a>
</div>
<div class=text-right>
<a href=/2020/06/gitlab-avoid-double-pipeline-run/#remark42>Комментариев: <span class=remark42__counter data-url=https://zzamzam.dev/2020/06/gitlab-avoid-double-pipeline-run/></span></a>
</div>
</div>
</div>
<div class="rounded-2 box-shadow-medium px-3 pb-2 pt-2 mb-3">
<div class="Subhead mb-2">
<div class=Subhead-heading>
<a href=/2020/03/helmfile-ogranization/>
<div class="h2 mt-1 mb-1">Организация деплоя в множество окружений с помощью helmfile</div>
</a>
</div>
<div class=Subhead-description>
<a href=/categories/helm class=muted-link>
<span class="Label Label--gray-darker">helm</span>
</a>
<a href=/categories/devops class=muted-link>
<span class="Label Label--gray-darker">devops</span>
</a>
<div class=float-md-right>
<span>2020-03-04</span>
</div>
</div>
</div>
<div class=text-gray>
<blockquote>
<p>Эта статья на Хабре <a href=https://habr.com/ru/post/491108/>https://habr.com/ru/post/491108/</a></p>
</blockquote>
<p><a href=https://github.com/roboll/helmfile>Helmfile</a> - обёртка для <a href=https://github.com/helm/helm/>helm</a>, которая позволяет в одном месте описывать множество helm релизов, параметризовать их чарты для нескольких окружений, а также задавать порядок их деплоя.</p>
<p>О самом helmfile и примерах его использования можно почитать в <a href=https://github.com/roboll/helmfile/blob/master/README.md>readme</a> и <a href=https://github.com/roboll/helmfile/blob/master/docs/writing-helmfile.md>best practices guide</a>.</p>
<p>Мы же познакомимся с неочевидными способами описать релизы в helmfile</p>
<p>Допустим, у нас есть пачка helm-чартов (для примера пусть будет postgres и некое backend приложение) и несколько окружений (несколько kubernetes кластеров, несколько namespace&rsquo;ов или несколько и того, и другого). Берём helmfile, читаем документацию и начинаем описывать наши окружения и релизы:</p>
<pre tabindex=0><code>    .
    ├── envs
    │   ├── devel
    │   │   └── values
    │   │       ├── backend.yaml
    │   │       └── postgres.yaml
    │   └── production
    │       └── values
    │           ├── backend.yaml
    │           └── postgres.yaml
    └── helmfile.yaml
</code></pre>
<div>
<a href=/2020/03/helmfile-ogranization/>Открыть полностью…</a>
</div>
<div class=text-right>
<a href=/2020/03/helmfile-ogranization/#remark42>Комментариев: <span class=remark42__counter data-url=https://zzamzam.dev/2020/03/helmfile-ogranization/></span></a>
</div>
</div>
</div>
<div class="rounded-2 box-shadow-medium px-3 pb-2 pt-2 mb-3">
<div class="Subhead mb-2">
<div class=Subhead-heading>
<a href=/2019/01/kubernetes-nodeport-loadbalancer-ingress-kogda-chto-ispolzovat/>
<div class="h2 mt-1 mb-1">Kubernetes NodePort / LoadBalancer / Ingress? Когда что использовать?</div>
</a>
</div>
<div class=Subhead-description>
<a href=/categories/devops class=muted-link>
<span class="Label Label--gray-darker">devops</span>
</a>
<a href=/categories/kubernetes class=muted-link>
<span class="Label Label--gray-darker">kubernetes</span>
</a>
<a href=/categories/%D0%BF%D0%B5%D1%80%D0%B5%D0%B2%D0%BE%D0%B4 class=muted-link>
<span class="Label Label--gray-darker">перевод</span>
</a>
<a href=/tags/devops class=muted-link>
<span class="Label Label--gray">devops</span>
</a>
<div class=float-md-right>
<span>2019-01-07</span>
</div>
</div>
</div>
<div class=text-gray>
<p>Чем отличаются всякие там <strong>NodePorts</strong>, <strong>LoadBalancer</strong> и <strong>Ingress</strong>? Все они дают возможность внешнему трафику попасть в ваш кластер, но дают эту возможность по-разному. Давайте-ка разберёмся, как они это делают и когда какой тип сервиса лучше использовать.</p>
<h1 id=clusterip>ClusterIP</h1>
<p>ClusterIP — это дефолтный тип сервиса в кубах, он поднимает вам сервис внутри кластера на внутрекластеровом IP. Доступа для внешнего трафика нет, только внутри кластера.</p>
<p>YAML для ClusterIP выглядит как-то так:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>  
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-internal-service</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>    
</span><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>my-app</span><span class=w>
</span><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>ClusterIP</span><span class=w>
</span><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>  
</span><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span><span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span><span class=w>    </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></code></pre></div><p>&ldquo;Так, ну и зачем же рассказывать нам о ClusterIP, если он не принимает внешний трафик?&rdquo; — спросите вы. А всё потому, что попасть на этот сервис можно через Kubernetes proxy!</p>
<div>
<a href=/2019/01/kubernetes-nodeport-loadbalancer-ingress-kogda-chto-ispolzovat/>Открыть полностью…</a>
</div>
<div class=text-right>
<a href=/2019/01/kubernetes-nodeport-loadbalancer-ingress-kogda-chto-ispolzovat/#remark42>Комментариев: <span class=remark42__counter data-url=https://zzamzam.dev/2019/01/kubernetes-nodeport-loadbalancer-ingress-kogda-chto-ispolzovat/></span></a>
</div>
</div>
</div>
<div class="rounded-2 box-shadow-medium px-3 pb-2 pt-2 mb-3">
<div class="Subhead mb-2">
<div class=Subhead-heading>
<a href=/2018/12/dapp-utilita-dlja-sborki-i-deploja-kontejne/>
<div class="h2 mt-1 mb-1">dapp — утилита для сборки и деплоя контейнеров. Особенности работы</div>
</a>
</div>
<div class=Subhead-description>
<a href=/categories/devops class=muted-link>
<span class="Label Label--gray-darker">devops</span>
</a>
<a href=/categories/linux class=muted-link>
<span class="Label Label--gray-darker">linux</span>
</a>
<a href=/tags/dapp class=muted-link>
<span class="Label Label--gray">dapp</span>
</a>
<a href=/tags/devops class=muted-link>
<span class="Label Label--gray">devops</span>
</a>
<a href=/tags/linux class=muted-link>
<span class="Label Label--gray">linux</span>
</a>
<div class=float-md-right>
<span>2018-12-03</span>
</div>
</div>
</div>
<div class=text-gray>
<figure class=img><img src=/wp-content/uploads/2018/12/logo_og-e1543878630388.png>
</figure>
<p><a href=https://github.com/flant/dapp>dapp</a> — утилита от российской компании Флант, которая занимается внедрением devops-практик (kubernetes, ci/cd и всё такое, ну вы в курсе) Подробное описание можно прочитать на <a href=https://habr.com/company/flant/blog/333682/>Хабре</a>, а я бы хотел остановиться на некоторых особенностях работы с ней при сборке образов (здесь и далее под образом подразумевается docker image)</p>
<p>На момент написания статьи актуальная версия dapp 0.36.*</p>
<p>В качестве примера для наглядности и понимания общей картины возьмём за основу немного урезанное содержимое <strong>dappfile.yaml</strong> из <a href=https://flant.github.io/dapp/how_to/getting_started.html>официальной документации</a></p>
<div>
<a href=/2018/12/dapp-utilita-dlja-sborki-i-deploja-kontejne/>Открыть полностью…</a>
</div>
<div class=text-right>
<a href=/2018/12/dapp-utilita-dlja-sborki-i-deploja-kontejne/#remark42>Комментариев: <span class=remark42__counter data-url=https://zzamzam.dev/2018/12/dapp-utilita-dlja-sborki-i-deploja-kontejne/></span></a>
</div>
</div>
</div>
</div>
</div>
<div id=footer class="pt-2 pb-3 bg-white text-center">
<span class="text-small text-gray">
Powered by the
<a href=https://github.com/qqhann/hugo-primer class=link-gray-dark>Hugo-Primer</a> theme for
<a href=https://gohugo.io class=link-gray-dark>Hugo</a>.
</span>
</div>
</div>
<script>var remark_config={host:'https://remark42.k8s.zzamzam.dev',site_id:'zzamzam_dev',components:['embed','counter']}</script>
<script>!function(d,b){for(var c=0,a,e,f;c<d.length;c++)a=b.createElement("script"),e=".js",f=b.head||b.body,"noModule"in a?(a.type="module",e=".mjs"):a.async=!0,a.defer=!0,a.src=remark_config.host+"/web/"+d[c]+e,f.appendChild(a)}(remark_config.components||["embed"],document)</script>
</body>
</html>