<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>FreePBX + Asternic CDR Reports + Recordings &ndash; Of Code & Systems</title><meta name=description property="og:description" content="FreePBX, Asternic CDR Reports и записи звонков
ВВЕДЕНИЕ
Классический CDR Reports, &amp;ldquo;идущий в комплекте&amp;rdquo; с FreePBX умеет делать отчёты с проигрыванием аудиозаписи, если она велась, но не умеет разграничивать доступы по Extension`ам (Extension Range, который задаётся при создании новой учётной записи админа).
Модуль Asternic CDR Reports учитывает это, но не выводит аудиофайл.
Исправим это.
Информация о звонках в Asterisk`е хранится в mysql базе данных asteriskcdrdb, таблица cdr.
|"><meta name=apple-mobile-web-app-title content="Of Code & Systems"><link rel=stylesheet href=/blog_hugo/assets/syntax.css><link rel=stylesheet href=/blog_hugo/assets/primer-build.css><link rel=stylesheet href=/blog_hugo/assets/style.css></head><body class=bg-gray><div id=holy class="container-lg bg-white h-100"><div id=header class="px-1 bg-white"><nav class="UnderlineNav UnderlineNav--right px-2"><a class="UnderlineNav-actions muted-link h2" href=https://zam-zam.github.io/blog_hugo/>Of Code & Systems</a></nav></div><div role=main id=main class="holy-main markdown-body px-4 bg-white"><div class=Subhead><div class=Subhead-heading><div class="h1 mt-3 mb-1">FreePBX + Asternic CDR Reports + Recordings</div></div><div class=Subhead-description><a href=/blog_hugo/categories/%D0%B1%D0%B5%D0%B7-%D1%80%D1%83%D0%B1%D1%80%D0%B8%D0%BA%D0%B8 class=muted-link><span class="Label Label--gray-darker">Без рубрики</span></a><div class=float-md-right><span title="Lastmod: 2014-09-10. Published at: 2014-09-10.">Published: 2014-09-10</span></div></div></div><article><section class="pb-6 mb-3 border-bottom"><p><img src=/wp-content/uploads/2014/09/2018-03-30_11-01-58.png alt></p><p>FreePBX, Asternic CDR Reports и записи звонков</p><p><strong>ВВЕДЕНИЕ</strong></p><p>Классический CDR Reports, &ldquo;идущий в комплекте&rdquo; с FreePBX умеет делать отчёты с проигрыванием аудиозаписи, если она велась, но не умеет разграничивать доступы по Extension`ам (Extension Range, который задаётся при создании новой учётной записи админа).</p><p>Модуль Asternic CDR Reports учитывает это, но не выводит аудиофайл.</p><p>Исправим это.</p><p>Информация о звонках в Asterisk`е хранится в mysql базе данных asteriskcdrdb, таблица cdr.</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=err>$</span><span class=n>resultscdr</span> <span class=o>=</span> <span class=err>$</span><span class=n>dbcdr</span><span class=o>-</span><span class=o>&gt;</span><span class=n>getAll</span><span class=p>(</span><span class=err>$</span><span class=n>query</span><span class=p>,</span> <span class=n>DB_FETCHMODE_ASSOC</span><span class=p>)</span><span class=p>;</span>
<span class=o>.</span><span class=o>.</span><span class=o>.</span>
<span class=n>foreach</span><span class=p>(</span><span class=err>$</span><span class=n>resultscdr</span> <span class=k>as</span> <span class=err>$</span><span class=n>row</span><span class=p>)</span>
<span class=o>.</span><span class=o>.</span><span class=o>.</span>
    <span class=k>if</span> <span class=p>(</span><span class=err>$</span><span class=n>row</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>recordingfile</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>)</span> <span class=p>{</span>
        <span class=err>$</span><span class=n>rec_parts</span> <span class=o>=</span> <span class=n>explode</span><span class=p>(</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>-</span><span class=s1>&#39;</span><span class=p>,</span><span class=err>$</span><span class=n>row</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>recordingfile</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>)</span><span class=p>;</span>
        <span class=err>$</span><span class=n>fyear</span> <span class=o>=</span> <span class=n>substr</span><span class=p>(</span><span class=err>$</span><span class=n>rec_parts</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>4</span><span class=p>)</span><span class=p>;</span>
        <span class=err>$</span><span class=n>fmonth</span> <span class=o>=</span> <span class=n>substr</span><span class=p>(</span><span class=err>$</span><span class=n>rec_parts</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span><span class=p>,</span><span class=mi>4</span><span class=p>,</span><span class=mi>2</span><span class=p>)</span><span class=p>;</span>
        <span class=err>$</span><span class=n>fday</span> <span class=o>=</span> <span class=n>substr</span><span class=p>(</span><span class=err>$</span><span class=n>rec_parts</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span><span class=p>,</span><span class=mi>6</span><span class=p>,</span><span class=mi>2</span><span class=p>)</span><span class=p>;</span>
        <span class=err>$</span><span class=n>monitor_base</span> <span class=o>=</span> <span class=err>$</span><span class=n>amp_conf</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>MIXMON_DIR</span><span class=s1>&#39;</span><span class=p>]</span> <span class=err>?</span> <span class=err>$</span><span class=n>amp_conf</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>MIXMON_DIR</span><span class=s1>&#39;</span><span class=p>]</span> <span class=p>:</span> <span class=err>$</span><span class=n>amp_conf</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>ASTSPOOLDIR</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>.</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>/monitor</span><span class=s1>&#39;</span><span class=p>;</span>
        <span class=err>$</span><span class=n>recordingfile</span> <span class=o>=</span> <span class=sa></span><span class=s2>&#34;</span><span class=s2>$monitor_base/$fyear/$fmonth/$fday/</span><span class=s2>&#34;</span> <span class=o>.</span> <span class=err>$</span><span class=n>row</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>recordingfile</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>;</span>
        <span class=k>if</span> <span class=p>(</span><span class=err>!</span><span class=n>file_exists</span><span class=p>(</span><span class=err>$</span><span class=n>recordingfile</span><span class=p>)</span><span class=p>)</span> <span class=p>{</span>
            <span class=err>$</span><span class=n>recordingfile</span> <span class=o>=</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>&#39;</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=err>$</span><span class=n>recordingfile</span> <span class=o>=</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>&#39;</span><span class=p>;</span>
    <span class=p>}</span>
<span class=o>.</span><span class=o>.</span><span class=o>.</span>
</code></pre></div><p>Из вышеприведённого кода файла page.cdr.php модуля обычного CDR Reports ясно, что всё, что нам нужно - это прочитать значение ячейки recordingfile (там хранится строка &ldquo;файл.wav&rdquo;) и добавить к нему полный путь к файлу, выдираемый, кстати, из самого же имени файла</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=err>$</span><span class=n>fyear</span> <span class=o>=</span> <span class=n>substr</span><span class=p>(</span><span class=err>$</span><span class=n>rec_parts</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>4</span><span class=p>)</span><span class=p>;</span>
<span class=err>$</span><span class=n>fmonth</span> <span class=o>=</span> <span class=n>substr</span><span class=p>(</span><span class=err>$</span><span class=n>rec_parts</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span><span class=p>,</span><span class=mi>4</span><span class=p>,</span><span class=mi>2</span><span class=p>)</span><span class=p>;</span>
<span class=err>$</span><span class=n>fday</span> <span class=o>=</span> <span class=n>substr</span><span class=p>(</span><span class=err>$</span><span class=n>rec_parts</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span><span class=p>,</span><span class=mi>6</span><span class=p>,</span><span class=mi>2</span><span class=p>)</span><span class=p>;</span>
<span class=err>$</span><span class=n>monitor_base</span> <span class=o>=</span> <span class=err>$</span><span class=n>amp_conf</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>MIXMON_DIR</span><span class=s1>&#39;</span><span class=p>]</span> <span class=err>?</span> <span class=err>$</span><span class=n>amp_conf</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>MIXMON_DIR</span><span class=s1>&#39;</span><span class=p>]</span> <span class=p>:</span> <span class=err>$</span><span class=n>amp_conf</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>ASTSPOOLDIR</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>.</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>/monitor</span><span class=s1>&#39;</span><span class=p>;</span>
<span class=err>$</span><span class=n>recordingfile</span> <span class=o>=</span> <span class=sa></span><span class=s2>&#34;</span><span class=s2>$monitor_base/$fyear/$fmonth/$fday/</span><span class=s2>&#34;</span> <span class=o>.</span> <span class=err>$</span><span class=n>row</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>recordingfile</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>;</span>
</code></pre></div><p>$amp_conf - глобальный массив, из которого берутся пути к записям. Поэтому, если менялся путь по-умолчанию, всё ок.</p><p><strong>ПРАКТИКА</strong></p><p>В файле functions.inc.php модуля Asternic ищем строку</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=err>$</span><span class=n>query</span><span class=o>.</span><span class=o>=</span> <span class=sa></span><span class=s2>&#34;</span><span class=s2>billsec,duration,duration-billsec as ringtime,src,</span><span class=s2>&#34;</span><span class=p>;</span>
</code></pre></div><p>добавляем к запросу recordingfile</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=err>$</span><span class=n>query</span><span class=o>.</span><span class=o>=</span> <span class=sa></span><span class=s2>&#34;</span><span class=s2>billsec,duration,duration-billsec as ringtime,src,recordingfile,</span><span class=s2>&#34;</span><span class=p>;</span>
</code></pre></div><p>Затем вместо</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=err>$</span><span class=n>detail</span><span class=p>[</span><span class=err>$</span><span class=n>row</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>chan1</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>]</span><span class=o>.</span><span class=o>=</span> <span class=sa></span><span class=s2>&#34;</span><span class=s2>n&lt;td&gt;</span><span class=s2>&#34;</span><span class=p>;</span>
 
<span class=err>$</span><span class=n>uni</span> <span class=o>=</span> <span class=err>$</span><span class=n>row</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>uniqueid</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>;</span>
<span class=err>$</span><span class=n>uni</span> <span class=o>=</span> <span class=n>str_replace</span><span class=p>(</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>.</span><span class=s2>&#34;</span><span class=p>,</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>&#34;</span><span class=p>,</span><span class=err>$</span><span class=n>uni</span><span class=p>)</span><span class=p>;</span>
 
<span class=k>if</span><span class=p>(</span><span class=err>$</span><span class=n>row</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>userfield</span><span class=s1>&#39;</span><span class=p>]</span><span class=o>&lt;</span><span class=o>&gt;</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>&#34;</span><span class=p>)</span> <span class=p>{</span>
  <span class=err>$</span><span class=n>detail</span><span class=p>[</span><span class=err>$</span><span class=n>row</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>chan1</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>]</span><span class=o>.</span><span class=o>=</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>&lt;a href=</span><span class=s2>&#34;</span><span class=n>javascript</span><span class=p>:</span><span class=n>void</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=p>;</span><span class=sa></span><span class=s2>&#34;</span><span class=s2> onclick=</span><span class=s2>&#39;</span><span class=s2>javascript:playVmail(</span><span class=s2>&#34;</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>.$row[</span><span class=s2>&#39;</span><span class=s2>userfield</span><span class=s2>&#39;</span><span class=s2>].</span><span class=s2>&#34;</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>,</span><span class=s2>&#34;</span><span class=n>play</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>.$uni.</span><span class=s2>&#34;</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>);</span><span class=s2>&#39;</span><span class=s2>&gt;</span><span class=s2>&#34;</span><span class=p>;</span>
  <span class=err>$</span><span class=n>detail</span><span class=p>[</span><span class=err>$</span><span class=n>row</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>chan1</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>]</span><span class=o>.</span><span class=o>=</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>&lt;div class=</span><span class=s2>&#39;</span><span class=s2>playicon</span><span class=s2>&#39;</span><span class=s2> title=</span><span class=s2>&#39;</span><span class=s2>Play</span><span class=s2>&#39;</span><span class=s2> id=</span><span class=s2>&#39;</span><span class=s2>play</span><span class=s2>&#34;</span><span class=o>.</span><span class=err>$</span><span class=n>uni</span><span class=o>.</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>&#39;</span><span class=s2>  style=</span><span class=s2>&#39;</span><span class=s2>float:left;</span><span class=s2>&#39;</span><span class=s2>&gt;</span><span class=s2>&#34;</span><span class=p>;</span>
  <span class=err>$</span><span class=n>detail</span><span class=p>[</span><span class=err>$</span><span class=n>row</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>chan1</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>]</span><span class=o>.</span><span class=o>=</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>&lt;img src=</span><span class=s2>&#39;</span><span class=s2>images/blank.gif</span><span class=s2>&#39;</span><span class=s2> alt=</span><span class=s2>&#39;</span><span class=s2>pixel</span><span class=s2>&#39;</span><span class=s2> height=</span><span class=s2>&#39;</span><span class=s2>16</span><span class=s2>&#39;</span><span class=s2> width=</span><span class=s2>&#39;</span><span class=s2>16</span><span class=s2>&#39;</span><span class=s2> border=</span><span class=s2>&#39;</span><span class=s2>0</span><span class=s2>&#39;</span><span class=s2>&gt;</span><span class=s2>&#34;</span><span class=p>;</span>
  <span class=err>$</span><span class=n>detail</span><span class=p>[</span><span class=err>$</span><span class=n>row</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>chan1</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>]</span><span class=o>.</span><span class=o>=</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>&lt;/div&gt;&lt;/a&gt;</span><span class=s2>&#34;</span><span class=p>;</span>
  <span class=err>$</span><span class=n>detail</span><span class=p>[</span><span class=err>$</span><span class=n>row</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>chan1</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>]</span><span class=o>.</span><span class=o>=</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>&lt;a href=</span><span class=s2>&#34;</span><span class=n>javascript</span><span class=p>:</span><span class=n>void</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=p>;</span> <span class=k>return</span> <span class=n>false</span><span class=p>;</span><span class=sa></span><span class=s2>&#34;</span><span class=s2> onclick=</span><span class=s2>&#39;</span><span class=s2>javascript:downloadVmail(</span><span class=s2>&#34;</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>.$row[</span><span class=s2>&#39;</span><span class=s2>userfield</span><span class=s2>&#39;</span><span class=s2>].</span><span class=s2>&#34;</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>,</span><span class=s2>&#34;</span><span class=n>play</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>.$uni.</span><span class=s2>&#34;</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>,</span><span class=s2>&#34;</span><span class=err>$</span><span class=n>ftype</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>,</span><span class=s2>&#34;</span><span class=err>$</span><span class=n>fdisplay</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>,</span><span class=s2>&#34;</span><span class=err>$</span><span class=n>ftab</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>); return false;</span><span class=s2>&#39;</span><span class=s2>&gt;</span><span class=s2>&#34;</span><span class=p>;</span>
  <span class=err>$</span><span class=n>detail</span><span class=p>[</span><span class=err>$</span><span class=n>row</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>chan1</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>]</span><span class=o>.</span><span class=o>=</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>&lt;div class=</span><span class=s2>&#39;</span><span class=s2>downicon</span><span class=s2>&#39;</span><span class=s2> title=</span><span class=s2>&#39;</span><span class=s2>Download</span><span class=s2>&#39;</span><span class=s2> id=</span><span class=s2>&#39;</span><span class=s2>dload</span><span class=s2>&#34;</span><span class=o>.</span><span class=err>$</span><span class=n>uni</span><span class=o>.</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>&#39;</span><span class=s2>  style=</span><span class=s2>&#39;</span><span class=s2>float:left;</span><span class=s2>&#39;</span><span class=s2>&gt;</span><span class=s2>&#34;</span><span class=p>;</span>
  <span class=err>$</span><span class=n>detail</span><span class=p>[</span><span class=err>$</span><span class=n>row</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>chan1</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>]</span><span class=o>.</span><span class=o>=</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>&lt;img src=</span><span class=s2>&#39;</span><span class=s2>images/blank.gif</span><span class=s2>&#39;</span><span class=s2> alt=</span><span class=s2>&#39;</span><span class=s2>pixel</span><span class=s2>&#39;</span><span class=s2> height=</span><span class=s2>&#39;</span><span class=s2>16</span><span class=s2>&#39;</span><span class=s2> width=</span><span class=s2>&#39;</span><span class=s2>16</span><span class=s2>&#39;</span><span class=s2> border=</span><span class=s2>&#39;</span><span class=s2>0</span><span class=s2>&#39;</span><span class=s2>&gt;</span><span class=s2>&#34;</span><span class=p>;</span>
  <span class=err>$</span><span class=n>detail</span><span class=p>[</span><span class=err>$</span><span class=n>row</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>chan1</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>]</span><span class=o>.</span><span class=o>=</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>&lt;/div&gt;&lt;/a&gt;</span><span class=s2>&#34;</span><span class=p>;</span>
<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
  <span class=err>$</span><span class=n>detail</span><span class=p>[</span><span class=err>$</span><span class=n>row</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>chan1</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>]</span><span class=o>.</span><span class=o>=</span> <span class=sa></span><span class=s2>&#34;</span><span class=s2>&amp;nbsp;</span><span class=s2>&#34;</span><span class=p>;</span>
<span class=p>}</span>
  <span class=err>$</span><span class=n>detail</span><span class=p>[</span><span class=err>$</span><span class=n>row</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>chan1</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>]</span><span class=o>.</span><span class=o>=</span> <span class=sa></span><span class=s2>&#34;</span><span class=s2>&lt;/td&gt;n</span><span class=s2>&#34;</span><span class=p>;</span>
</code></pre></div><p>ставим</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=k>if</span> <span class=p>(</span><span class=err>$</span><span class=n>row</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>recordingfile</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>)</span> <span class=p>{</span>
  <span class=err>$</span><span class=n>rec_parts</span> <span class=o>=</span> <span class=n>explode</span><span class=p>(</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>-</span><span class=s1>&#39;</span><span class=p>,</span><span class=err>$</span><span class=n>row</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>recordingfile</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>)</span><span class=p>;</span>
  <span class=err>$</span><span class=n>fyear</span> <span class=o>=</span> <span class=n>substr</span><span class=p>(</span><span class=err>$</span><span class=n>rec_parts</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>4</span><span class=p>)</span><span class=p>;</span>
  <span class=err>$</span><span class=n>fmonth</span> <span class=o>=</span> <span class=n>substr</span><span class=p>(</span><span class=err>$</span><span class=n>rec_parts</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span><span class=p>,</span><span class=mi>4</span><span class=p>,</span><span class=mi>2</span><span class=p>)</span><span class=p>;</span>
  <span class=err>$</span><span class=n>fday</span> <span class=o>=</span> <span class=n>substr</span><span class=p>(</span><span class=err>$</span><span class=n>rec_parts</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span><span class=p>,</span><span class=mi>6</span><span class=p>,</span><span class=mi>2</span><span class=p>)</span><span class=p>;</span>
  <span class=err>$</span><span class=n>monitor_base</span> <span class=o>=</span> <span class=err>$</span><span class=n>amp_conf</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>MIXMON_DIR</span><span class=s1>&#39;</span><span class=p>]</span> <span class=err>?</span> <span class=err>$</span><span class=n>amp_conf</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>MIXMON_DIR</span><span class=s1>&#39;</span><span class=p>]</span> <span class=p>:</span> <span class=err>$</span><span class=n>amp_conf</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>ASTSPOOLDIR</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>.</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>/monitor</span><span class=s1>&#39;</span><span class=p>;</span>
  <span class=err>$</span><span class=n>recordingfile</span> <span class=o>=</span> <span class=sa></span><span class=s2>&#34;</span><span class=s2>$monitor_base/$fyear/$fmonth/$fday/</span><span class=s2>&#34;</span> <span class=o>.</span> <span class=err>$</span><span class=n>row</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>recordingfile</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>;</span>
  <span class=k>if</span> <span class=p>(</span><span class=err>!</span><span class=n>file_exists</span><span class=p>(</span><span class=err>$</span><span class=n>recordingfile</span><span class=p>)</span><span class=p>)</span> <span class=p>{</span>
    <span class=err>$</span><span class=n>recordingfile</span> <span class=o>=</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>&#39;</span><span class=p>;</span>
    <span class=err>$</span><span class=n>detail</span><span class=p>[</span><span class=err>$</span><span class=n>row</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>chan1</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>]</span><span class=o>.</span><span class=o>=</span> <span class=sa></span><span class=s2>&#34;</span><span class=s2>n&lt;td&gt;</span><span class=s2>&#34;</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=k>else</span> <span class=p>{</span>
    <span class=err>$</span><span class=n>detail</span><span class=p>[</span><span class=err>$</span><span class=n>row</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>chan1</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>]</span><span class=o>.</span><span class=o>=</span> <span class=sa></span><span class=s2>&#34;</span><span class=s2>n&lt;td style=</span><span class=s2>&#39;</span><span class=s2>text-align: center;</span><span class=s2>&#39;</span><span class=s2> title=</span><span class=s2>&#34;</span><span class=err>$</span><span class=n>row</span><span class=p>[</span><span class=n>recordingfile</span><span class=p>]</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>&gt;&lt;a href=</span><span class=s2>&#34;</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>.$PHP_SELF.</span><span class=s2>&#34;</span><span class=err>?</span><span class=n>getRec</span><span class=o>=</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>.base64_encode($recordingfile).</span><span class=s2>&#34;</span><span class=sa></span><span class=s2>&#34;</span><span class=s2> target=</span><span class=s2>&#34;</span><span class=n>_blank</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>&gt;&lt;img src=</span><span class=s2>&#34;</span><span class=n>images</span><span class=o>/</span><span class=n>asternic_playicon</span><span class=o>.</span><span class=n>png</span><span class=sa></span><span class=s2>&#34;</span><span class=s2> alt=</span><span class=s2>&#34;</span><span class=n>Call</span> <span class=n>recording</span><span class=sa></span><span class=s2>&#34;</span><span class=s2> /&gt;&lt;/a&gt;</span><span class=s2>&#34;</span><span class=p>;</span>
  <span class=p>}</span>
<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
  <span class=err>$</span><span class=n>recordingfile</span> <span class=o>=</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>&#39;</span><span class=p>;</span>
  <span class=err>$</span><span class=n>detail</span><span class=p>[</span><span class=err>$</span><span class=n>row</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>chan1</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>]</span><span class=o>.</span><span class=o>=</span> <span class=sa></span><span class=s2>&#34;</span><span class=s2>n&lt;td&gt;</span><span class=s2>&#34;</span><span class=p>;</span>
<span class=p>}</span>
  <span class=err>$</span><span class=n>detail</span><span class=p>[</span><span class=err>$</span><span class=n>row</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>chan1</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>]</span><span class=o>.</span><span class=o>=</span> <span class=sa></span><span class=s2>&#34;</span><span class=s2>&lt;/td&gt;n</span><span class=s2>&#34;</span><span class=p>;</span>
</code></pre></div><p>По-умолчанию в ячейке Listen в Asternic выводится запись голосовой почты, но нас-то интересует запись звонка, поэтому меняем содержимое всей ячейки.</p><p>В конце файла добавляем ещё функцию, отдающую файл двоичными данными (т.е. никакой apache не имеет доступа к каталогу записи, а отдаётся всё через php) и проверку на наличие переменной getRec, в случае наличия которой получаем файл.</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=n>function</span> <span class=n>recordfile_uri</span><span class=p>(</span><span class=err>$</span><span class=n>path</span><span class=p>)</span> <span class=p>{</span>
  <span class=err>$</span><span class=n>size</span> <span class=o>=</span> <span class=n>filesize</span><span class=p>(</span><span class=err>$</span><span class=n>path</span><span class=p>)</span><span class=p>;</span>
  <span class=err>$</span><span class=n>name</span> <span class=o>=</span> <span class=n>basename</span><span class=p>(</span><span class=err>$</span><span class=n>path</span><span class=p>)</span><span class=p>;</span>
  <span class=err>$</span><span class=n>extension</span> <span class=o>=</span> <span class=n>strtolower</span><span class=p>(</span><span class=n>substr</span><span class=p>(</span><span class=n>strrchr</span><span class=p>(</span><span class=err>$</span><span class=n>name</span><span class=p>,</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>.</span><span class=s2>&#34;</span><span class=p>)</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span><span class=p>)</span><span class=p>;</span>
  <span class=o>/</span><span class=o>/</span> <span class=n>This</span> <span class=n>will</span> <span class=nb>set</span> <span class=n>the</span> <span class=n>Content</span><span class=o>-</span><span class=n>Type</span> <span class=n>to</span> <span class=n>the</span> <span class=n>appropriate</span> <span class=n>setting</span> <span class=k>for</span> <span class=n>the</span> <span class=nb>file</span>
  <span class=err>$</span><span class=n>ctype</span> <span class=o>=</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>&#39;</span><span class=p>;</span>
  <span class=n>switch</span><span class=p>(</span> <span class=err>$</span><span class=n>extension</span> <span class=p>)</span> <span class=p>{</span>
    <span class=n>case</span> <span class=sa></span><span class=s2>&#34;</span><span class=s2>WAV</span><span class=s2>&#34;</span><span class=p>:</span>
    <span class=err>$</span><span class=n>ctype</span><span class=o>=</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>audio/x-wav</span><span class=s2>&#34;</span><span class=p>;</span>
    <span class=k>break</span><span class=p>;</span>
  <span class=n>case</span> <span class=sa></span><span class=s2>&#34;</span><span class=s2>wav</span><span class=s2>&#34;</span><span class=p>:</span>
    <span class=err>$</span><span class=n>ctype</span><span class=o>=</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>audio/x-wav</span><span class=s2>&#34;</span><span class=p>;</span>
    <span class=k>break</span><span class=p>;</span>
  <span class=n>case</span> <span class=sa></span><span class=s2>&#34;</span><span class=s2>ulaw</span><span class=s2>&#34;</span><span class=p>:</span>
    <span class=err>$</span><span class=n>ctype</span><span class=o>=</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>audio/basic</span><span class=s2>&#34;</span><span class=p>;</span>
    <span class=k>break</span><span class=p>;</span>
  <span class=n>case</span> <span class=sa></span><span class=s2>&#34;</span><span class=s2>alaw</span><span class=s2>&#34;</span><span class=p>:</span>
    <span class=err>$</span><span class=n>ctype</span><span class=o>=</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>audio/x-alaw-basic</span><span class=s2>&#34;</span><span class=p>;</span>
    <span class=k>break</span><span class=p>;</span>
  <span class=n>case</span> <span class=sa></span><span class=s2>&#34;</span><span class=s2>sln</span><span class=s2>&#34;</span><span class=p>:</span>
    <span class=err>$</span><span class=n>ctype</span><span class=o>=</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>audio/x-wav</span><span class=s2>&#34;</span><span class=p>;</span>
    <span class=k>break</span><span class=p>;</span>
  <span class=n>case</span> <span class=sa></span><span class=s2>&#34;</span><span class=s2>gsm</span><span class=s2>&#34;</span><span class=p>:</span>
    <span class=err>$</span><span class=n>ctype</span><span class=o>=</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>audio/x-gsm</span><span class=s2>&#34;</span><span class=p>;</span>
    <span class=k>break</span><span class=p>;</span>
  <span class=n>case</span> <span class=sa></span><span class=s2>&#34;</span><span class=s2>g729</span><span class=s2>&#34;</span><span class=p>:</span>
    <span class=err>$</span><span class=n>ctype</span><span class=o>=</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>audio/x-g729</span><span class=s2>&#34;</span><span class=p>;</span>
    <span class=k>break</span><span class=p>;</span>
  <span class=n>default</span><span class=p>:</span> <span class=o>/</span><span class=o>/</span><span class=ow>not</span> <span class=n>downloadable</span>
    <span class=o>/</span><span class=o>/</span> <span class=n>echo</span> <span class=p>(</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>&lt;b&gt;404 File not found! foo&lt;/b&gt;</span><span class=s2>&#34;</span><span class=p>)</span><span class=p>;</span>
    <span class=o>/</span><span class=o>/</span> <span class=n>TODO</span><span class=p>:</span> <span class=n>what</span> <span class=n>to</span> <span class=n>do</span> <span class=k>if</span> <span class=n>none</span> <span class=n>of</span> <span class=n>the</span> <span class=n>above</span> <span class=n>work</span><span class=err>?</span>
    <span class=k>break</span> <span class=p>;</span>
  <span class=p>}</span>
 
  <span class=err>$</span><span class=n>fp</span><span class=o>=</span><span class=n>fopen</span><span class=p>(</span><span class=err>$</span><span class=n>path</span><span class=p>,</span> <span class=sa></span><span class=s2>&#34;</span><span class=s2>rb</span><span class=s2>&#34;</span><span class=p>)</span><span class=p>;</span>
  <span class=k>if</span> <span class=p>(</span><span class=err>$</span><span class=n>size</span> <span class=o>&amp;</span><span class=o>&amp;</span> <span class=err>$</span><span class=n>ctype</span> <span class=o>&amp;</span><span class=o>&amp;</span> <span class=err>$</span><span class=n>fp</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>header</span><span class=p>(</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>Pragma: public</span><span class=s2>&#34;</span><span class=p>)</span><span class=p>;</span>
    <span class=n>header</span><span class=p>(</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>Expires: 0</span><span class=s2>&#34;</span><span class=p>)</span><span class=p>;</span>
    <span class=n>header</span><span class=p>(</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>Cache-Control: must-revalidate, post-check=0, pre-check=0</span><span class=s2>&#34;</span><span class=p>)</span><span class=p>;</span>
    <span class=n>header</span><span class=p>(</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>Cache-Control: public</span><span class=s2>&#34;</span><span class=p>)</span><span class=p>;</span>
    <span class=n>header</span><span class=p>(</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>Content-Description: audio file</span><span class=s2>&#34;</span><span class=p>)</span><span class=p>;</span>
    <span class=n>header</span><span class=p>(</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>Content-Type: </span><span class=s2>&#34;</span> <span class=o>.</span> <span class=err>$</span><span class=n>ctype</span><span class=p>)</span><span class=p>;</span>
    <span class=n>header</span><span class=p>(</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>Content-Disposition: attachment; filename=</span><span class=s2>&#34;</span> <span class=o>.</span> <span class=err>$</span><span class=n>name</span><span class=p>)</span><span class=p>;</span>
    <span class=n>header</span><span class=p>(</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>Content-Transfer-Encoding: binary</span><span class=s2>&#34;</span><span class=p>)</span><span class=p>;</span>
    <span class=n>header</span><span class=p>(</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>Content-length: </span><span class=s2>&#34;</span> <span class=o>.</span> <span class=err>$</span><span class=n>size</span><span class=p>)</span><span class=p>;</span>
    <span class=err>$</span><span class=n>chunksize</span> <span class=o>=</span> <span class=mi>1</span><span class=o>*</span><span class=p>(</span><span class=mi>1024</span><span class=o>*</span><span class=mi>1024</span><span class=p>)</span><span class=p>;</span>
    <span class=k>while</span> <span class=p>(</span><span class=err>!</span><span class=n>feof</span><span class=p>(</span><span class=err>$</span><span class=n>fp</span><span class=p>)</span><span class=p>)</span> <span class=p>{</span>
      <span class=err>$</span><span class=nb>buffer</span> <span class=o>=</span> <span class=n>fread</span><span class=p>(</span><span class=err>$</span><span class=n>fp</span><span class=p>,</span> <span class=err>$</span><span class=n>chunksize</span><span class=p>)</span><span class=p>;</span>
      <span class=n>echo</span> <span class=err>$</span><span class=nb>buffer</span><span class=p>;</span>
      <span class=n>ob_flush</span><span class=p>(</span><span class=p>)</span><span class=p>;</span>
      <span class=n>flush</span><span class=p>(</span><span class=p>)</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=n>fclose</span><span class=p>(</span><span class=err>$</span><span class=n>fp</span><span class=p>)</span><span class=p>;</span>
  <span class=p>}</span>
<span class=p>}</span>
<span class=k>if</span><span class=p>(</span><span class=n>isset</span><span class=p>(</span><span class=err>$</span><span class=n>_GET</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>getRec</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>)</span><span class=p>)</span><span class=p>{</span>
  <span class=n>recordfile_uri</span><span class=p>(</span><span class=n>base64_decode</span><span class=p>(</span><span class=err>$</span><span class=n>_GET</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>getRec</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>)</span><span class=p>)</span><span class=p>;</span>
  <span class=n>die</span><span class=p>(</span><span class=p>)</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div></section><section></section></article></div><div id=side class="pr-1 bg-white"><aside class=pr-3><div id=toc class="Box Box--blue mb-3"><b>FreePBX + Asternic CDR Reports + Recordings</b><nav id=TableOfContents></nav></div><div></div></aside></div><div id=footer class="pt-2 pb-3 bg-white text-center"><span class="text-small text-gray">Powered by the
<a href=https://github.com/qqhann/hugo-primer class=link-gray-dark>Hugo-Primer</a> theme for
<a href=https://gohugo.io class=link-gray-dark>Hugo</a>.</span></div></div><script type=text/javascript src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script type=text/x-mathjax-config>MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script></body></html>