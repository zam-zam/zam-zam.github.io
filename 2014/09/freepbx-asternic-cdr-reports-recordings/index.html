<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>FreePBX + Asternic CDR Reports + Recordings &ndash; Of Code & Systems</title><meta name=description property="og:description" content="FreePBX, Asternic CDR Reports и записи звонков
ВВЕДЕНИЕ
Классический CDR Reports, &amp;ldquo;идущий в комплекте&amp;rdquo; с FreePBX умеет делать отчёты с проигрыванием аудиозаписи, если она велась, но не умеет разграничивать доступы по Extension`ам (Extension Range, который задаётся при создании новой учётной записи админа).
Модуль Asternic CDR Reports учитывает это, но не выводит аудиофайл.
Исправим это.
Информация о звонках в Asterisk`е хранится в mysql базе данных asteriskcdrdb, таблица cdr.
|"><meta name=apple-mobile-web-app-title content="Of Code & Systems"><link rel=stylesheet href=/assets/syntax.css><link rel=stylesheet href=/assets/primer-build.css><link rel=stylesheet href=/assets/style.css></head><body class=bg-gray><div id=holy class="container-lg bg-white h-100"><div id=header class="px-1 bg-white"><nav class="UnderlineNav UnderlineNav--right px-2"><a class="UnderlineNav-actions muted-link h2" href=/>Of Code & Systems</a></nav></div><div role=main id=main class="holy-main markdown-body px-4 bg-white"><div class=Subhead><div class=Subhead-heading><div class="h1 mt-3 mb-1">FreePBX + Asternic CDR Reports + Recordings</div></div><div class=Subhead-description><a href=/categories/%D0%B1%D0%B5%D0%B7-%D1%80%D1%83%D0%B1%D1%80%D0%B8%D0%BA%D0%B8 class=muted-link><span class="Label Label--gray-darker">Без рубрики</span></a><div class=float-md-right><span title="Lastmod: 2014-09-10. Published at: 2014-09-10.">Published: 2014-09-10</span></div></div></div><article><section class="pb-6 mb-3 border-bottom"><p><img src=/wp-content/uploads/2014/09/2018-03-30_11-01-58.png alt></p><p>FreePBX, Asternic CDR Reports и записи звонков</p><p><strong>ВВЕДЕНИЕ</strong></p><p>Классический CDR Reports, &ldquo;идущий в комплекте&rdquo; с FreePBX умеет делать отчёты с проигрыванием аудиозаписи, если она велась, но не умеет разграничивать доступы по Extension`ам (Extension Range, который задаётся при создании новой учётной записи админа).</p><p>Модуль Asternic CDR Reports учитывает это, но не выводит аудиофайл.</p><p>Исправим это.</p><p>Информация о звонках в Asterisk`е хранится в mysql базе данных asteriskcdrdb, таблица cdr.</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php>$resultscdr = $dbcdr-&gt;getAll($query, DB_FETCHMODE_ASSOC);
...
foreach($resultscdr as $row)
...
    if ($row[&#39;recordingfile&#39;]) {
        $rec_parts = explode(&#39;-&#39;,$row[&#39;recordingfile&#39;]);
        $fyear = substr($rec_parts[3],0,4);
        $fmonth = substr($rec_parts[3],4,2);
        $fday = substr($rec_parts[3],6,2);
        $monitor_base = $amp_conf[&#39;MIXMON_DIR&#39;] ? $amp_conf[&#39;MIXMON_DIR&#39;] : $amp_conf[&#39;ASTSPOOLDIR&#39;] . &#39;/monitor&#39;;
        $recordingfile = &#34;$monitor_base/$fyear/$fmonth/$fday/&#34; . $row[&#39;recordingfile&#39;];
        if (!file_exists($recordingfile)) {
            $recordingfile = &#39;&#39;;
        }
    } else {
        $recordingfile = &#39;&#39;;
    }
...
</code></pre></div><p>Из вышеприведённого кода файла page.cdr.php модуля обычного CDR Reports ясно, что всё, что нам нужно - это прочитать значение ячейки recordingfile (там хранится строка &ldquo;файл.wav&rdquo;) и добавить к нему полный путь к файлу, выдираемый, кстати, из самого же имени файла</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php>$fyear = substr($rec_parts[3],0,4);
$fmonth = substr($rec_parts[3],4,2);
$fday = substr($rec_parts[3],6,2);
$monitor_base = $amp_conf[&#39;MIXMON_DIR&#39;] ? $amp_conf[&#39;MIXMON_DIR&#39;] : $amp_conf[&#39;ASTSPOOLDIR&#39;] . &#39;/monitor&#39;;
$recordingfile = &#34;$monitor_base/$fyear/$fmonth/$fday/&#34; . $row[&#39;recordingfile&#39;];
</code></pre></div><p>$amp_conf - глобальный массив, из которого берутся пути к записям. Поэтому, если менялся путь по-умолчанию, всё ок.</p><p><strong>ПРАКТИКА</strong></p><p>В файле functions.inc.php модуля Asternic ищем строку</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php>$query.= &#34;billsec,duration,duration-billsec as ringtime,src,&#34;;
</code></pre></div><p>добавляем к запросу recordingfile</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php>$query.= &#34;billsec,duration,duration-billsec as ringtime,src,recordingfile,&#34;;
</code></pre></div><p>Затем вместо</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php>$detail[$row[&#39;chan1&#39;]].= &#34;n<span class=p>&lt;</span><span class=nt>td</span><span class=p></span><span class=p>&gt;</span>&#34;;
 
$uni = $row[&#39;uniqueid&#39;];
$uni = str_replace(&#34;.&#34;,&#34;&#34;,$uni);
 
if($row[&#39;userfield&#39;]<span class=err>&lt;</span>&gt;&#34;&#34;) {
  $detail[$row[&#39;chan1&#39;]].=&#34;<span class=p>&lt;</span><span class=nt>a</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;javascript:void(0);&#34;</span> <span class=na>onclick</span><span class=o>=</span><span class=s>&#39;javascript:playVmail(&#34;&#34;.$row[&#39;</span><span class=na>userfield</span><span class=err>&#39;</span><span class=err>]</span><span class=err>.</span><span class=err>&#34;</span><span class=err>&#34;</span><span class=err>,</span><span class=err>&#34;</span><span class=na>play</span><span class=err>&#34;</span><span class=err>.</span><span class=err>$</span><span class=na>uni</span><span class=err>.</span><span class=err>&#34;</span><span class=err>&#34;</span><span class=err>)</span><span class=err>;</span><span class=err>&#39;</span><span class=p></span><span class=p>&gt;</span>&#34;;
  $detail[$row[&#39;chan1&#39;]].=&#34;<span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#39;playicon&#39;</span> <span class=na>title</span><span class=o>=</span><span class=s>&#39;Play&#39;</span> <span class=na>id</span><span class=o>=</span><span class=s>&#39;play&#34;.$uni.&#34;&#39;</span>  <span class=na>style</span><span class=o>=</span><span class=s>&#39;float:left;&#39;</span><span class=p></span><span class=p>&gt;</span>&#34;;
  $detail[$row[&#39;chan1&#39;]].=&#34;<span class=p>&lt;</span><span class=nt>img</span> <span class=na>src</span><span class=o>=</span><span class=s>&#39;images/blank.gif&#39;</span> <span class=na>alt</span><span class=o>=</span><span class=s>&#39;pixel&#39;</span> <span class=na>height</span><span class=o>=</span><span class=s>&#39;16&#39;</span> <span class=na>width</span><span class=o>=</span><span class=s>&#39;16&#39;</span> <span class=na>border</span><span class=o>=</span><span class=s>&#39;0&#39;</span><span class=p></span><span class=p>&gt;</span>&#34;;
  $detail[$row[&#39;chan1&#39;]].=&#34;<span class=p>&lt;</span><span class=p>/</span><span class=nt>div</span><span class=p>&gt;</span><span class=p>&lt;</span><span class=p>/</span><span class=nt>a</span><span class=p>&gt;</span>&#34;;
  $detail[$row[&#39;chan1&#39;]].=&#34;<span class=p>&lt;</span><span class=nt>a</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;javascript:void(0); return false;&#34;</span> <span class=na>onclick</span><span class=o>=</span><span class=s>&#39;javascript:downloadVmail(&#34;&#34;.$row[&#39;</span><span class=na>userfield</span><span class=err>&#39;</span><span class=err>]</span><span class=err>.</span><span class=err>&#34;</span><span class=err>&#34;</span><span class=err>,</span><span class=err>&#34;</span><span class=na>play</span><span class=err>&#34;</span><span class=err>.</span><span class=err>$</span><span class=na>uni</span><span class=err>.</span><span class=err>&#34;</span><span class=err>&#34;</span><span class=err>,</span><span class=err>&#34;</span><span class=err>$</span><span class=na>ftype</span><span class=err>&#34;</span><span class=err>,</span><span class=err>&#34;</span><span class=err>$</span><span class=na>fdisplay</span><span class=err>&#34;</span><span class=err>,</span><span class=err>&#34;</span><span class=err>$</span><span class=na>ftab</span><span class=err>&#34;</span><span class=err>)</span><span class=err>;</span> <span class=na>return</span> <span class=na>false</span><span class=err>;</span><span class=err>&#39;</span><span class=p></span><span class=p>&gt;</span>&#34;;
  $detail[$row[&#39;chan1&#39;]].=&#34;<span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#39;downicon&#39;</span> <span class=na>title</span><span class=o>=</span><span class=s>&#39;Download&#39;</span> <span class=na>id</span><span class=o>=</span><span class=s>&#39;dload&#34;.$uni.&#34;&#39;</span>  <span class=na>style</span><span class=o>=</span><span class=s>&#39;float:left;&#39;</span><span class=p></span><span class=p>&gt;</span>&#34;;
  $detail[$row[&#39;chan1&#39;]].=&#34;<span class=p>&lt;</span><span class=nt>img</span> <span class=na>src</span><span class=o>=</span><span class=s>&#39;images/blank.gif&#39;</span> <span class=na>alt</span><span class=o>=</span><span class=s>&#39;pixel&#39;</span> <span class=na>height</span><span class=o>=</span><span class=s>&#39;16&#39;</span> <span class=na>width</span><span class=o>=</span><span class=s>&#39;16&#39;</span> <span class=na>border</span><span class=o>=</span><span class=s>&#39;0&#39;</span><span class=p></span><span class=p>&gt;</span>&#34;;
  $detail[$row[&#39;chan1&#39;]].=&#34;<span class=p>&lt;</span><span class=p>/</span><span class=nt>div</span><span class=p>&gt;</span><span class=p>&lt;</span><span class=p>/</span><span class=nt>a</span><span class=p>&gt;</span>&#34;;
} else {
  $detail[$row[&#39;chan1&#39;]].= &#34;<span class=ni>&amp;nbsp;</span>&#34;;
}
  $detail[$row[&#39;chan1&#39;]].= &#34;<span class=p>&lt;</span><span class=p>/</span><span class=nt>td</span><span class=p>&gt;</span>n&#34;;
</code></pre></div><p>ставим</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php>if ($row[&#39;recordingfile&#39;]) {
  $rec_parts = explode(&#39;-&#39;,$row[&#39;recordingfile&#39;]);
  $fyear = substr($rec_parts[3],0,4);
  $fmonth = substr($rec_parts[3],4,2);
  $fday = substr($rec_parts[3],6,2);
  $monitor_base = $amp_conf[&#39;MIXMON_DIR&#39;] ? $amp_conf[&#39;MIXMON_DIR&#39;] : $amp_conf[&#39;ASTSPOOLDIR&#39;] . &#39;/monitor&#39;;
  $recordingfile = &#34;$monitor_base/$fyear/$fmonth/$fday/&#34; . $row[&#39;recordingfile&#39;];
  if (!file_exists($recordingfile)) {
    $recordingfile = &#39;&#39;;
    $detail[$row[&#39;chan1&#39;]].= &#34;n<span class=p>&lt;</span><span class=nt>td</span><span class=p></span><span class=p>&gt;</span>&#34;;
  }
  else {
    $detail[$row[&#39;chan1&#39;]].= &#34;n<span class=p>&lt;</span><span class=nt>td</span> <span class=na>style</span><span class=o>=</span><span class=s>&#39;text-align: center;&#39;</span> <span class=na>title</span><span class=o>=</span><span class=s>&#34;$row[recordingfile]&#34;</span><span class=p></span><span class=p>&gt;</span><span class=p>&lt;</span><span class=nt>a</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;&#34;</span><span class=err>.</span><span class=err>$</span><span class=na>PHP_SELF</span><span class=err>.</span><span class=err>&#34;</span><span class=err>?</span><span class=na>getRec</span><span class=o>=</span><span class=s>&#34;.base64_encode($recordingfile).&#34;</span><span class=err>&#34;</span> <span class=na>target</span><span class=o>=</span><span class=s>&#34;_blank&#34;</span><span class=p></span><span class=p>&gt;</span><span class=p>&lt;</span><span class=nt>img</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;images/asternic_playicon.png&#34;</span> <span class=na>alt</span><span class=o>=</span><span class=s>&#34;Call recording&#34;</span> <span class=p>/</span><span class=p>&gt;</span><span class=p>&lt;</span><span class=p>/</span><span class=nt>a</span><span class=p>&gt;</span>&#34;;
  }
} else {
  $recordingfile = &#39;&#39;;
  $detail[$row[&#39;chan1&#39;]].= &#34;n<span class=p>&lt;</span><span class=nt>td</span><span class=p></span><span class=p>&gt;</span>&#34;;
}
  $detail[$row[&#39;chan1&#39;]].= &#34;<span class=p>&lt;</span><span class=p>/</span><span class=nt>td</span><span class=p>&gt;</span>n&#34;;
</code></pre></div><p>По-умолчанию в ячейке Listen в Asternic выводится запись голосовой почты, но нас-то интересует запись звонка, поэтому меняем содержимое всей ячейки.</p><p>В конце файла добавляем ещё функцию, отдающую файл двоичными данными (т.е. никакой apache не имеет доступа к каталогу записи, а отдаётся всё через php) и проверку на наличие переменной getRec, в случае наличия которой получаем файл.</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php>function recordfile_uri($path) {
  $size = filesize($path);
  $name = basename($path);
  $extension = strtolower(substr(strrchr($name,&#34;.&#34;),1));
  // This will set the Content-Type to the appropriate setting for the file
  $ctype =&#39;&#39;;
  switch( $extension ) {
    case &#34;WAV&#34;:
    $ctype=&#34;audio/x-wav&#34;;
    break;
  case &#34;wav&#34;:
    $ctype=&#34;audio/x-wav&#34;;
    break;
  case &#34;ulaw&#34;:
    $ctype=&#34;audio/basic&#34;;
    break;
  case &#34;alaw&#34;:
    $ctype=&#34;audio/x-alaw-basic&#34;;
    break;
  case &#34;sln&#34;:
    $ctype=&#34;audio/x-wav&#34;;
    break;
  case &#34;gsm&#34;:
    $ctype=&#34;audio/x-gsm&#34;;
    break;
  case &#34;g729&#34;:
    $ctype=&#34;audio/x-g729&#34;;
    break;
  default: //not downloadable
    // echo (&#34;<span class=p>&lt;</span><span class=nt>b</span><span class=p></span><span class=p>&gt;</span>404 File not found! foo<span class=p>&lt;</span><span class=p>/</span><span class=nt>b</span><span class=p>&gt;</span>&#34;);
    // TODO: what to do if none of the above work?
    break ;
  }
 
  $fp=fopen($path, &#34;rb&#34;);
  if ($size <span class=err>&amp;</span><span class=err>&amp;</span> $ctype <span class=err>&amp;</span><span class=err>&amp;</span> $fp) {
    header(&#34;Pragma: public&#34;);
    header(&#34;Expires: 0&#34;);
    header(&#34;Cache-Control: must-revalidate, post-check=0, pre-check=0&#34;);
    header(&#34;Cache-Control: public&#34;);
    header(&#34;Content-Description: audio file&#34;);
    header(&#34;Content-Type: &#34; . $ctype);
    header(&#34;Content-Disposition: attachment; filename=&#34; . $name);
    header(&#34;Content-Transfer-Encoding: binary&#34;);
    header(&#34;Content-length: &#34; . $size);
    $chunksize = 1*(1024*1024);
    while (!feof($fp)) {
      $buffer = fread($fp, $chunksize);
      echo $buffer;
      ob_flush();
      flush();
    }
    fclose($fp);
  }
}
if(isset($_GET[&#39;getRec&#39;])){
  recordfile_uri(base64_decode($_GET[&#39;getRec&#39;]));
  die();
}
</code></pre></div></section><section><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"blog-zamolod-ru"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></article></div><div id=side class="pr-1 bg-white"><aside class=pr-3><div id=toc class="Box Box--blue mb-3"><b>FreePBX + Asternic CDR Reports + Recordings</b><nav id=TableOfContents></nav></div><div></div></aside></div><div id=footer class="pt-2 pb-3 bg-white text-center"><span class="text-small text-gray">Powered by the
<a href=https://github.com/qqhann/hugo-primer class=link-gray-dark>Hugo-Primer</a> theme for
<a href=https://gohugo.io class=link-gray-dark>Hugo</a>.</span></div></div><script type=text/javascript src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script type=text/x-mathjax-config>MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script></body></html>